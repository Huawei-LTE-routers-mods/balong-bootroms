#!/usr/bin/env python3
import sys
import serial

# Disable Secure Boot (write 2x 0x00000000 to 0x4FE1FFEC)
DISABLE_SECUBOOT_1 = b"\xFE\x00\xFF\x01\x00\x00\x00\x08\x4F\xE1\xFF\xEC\xA8\xA3"
DISABLE_SECUBOOT_2 = b"\xDA\x01\xFE\x00\x00\x00\x00\x00\x00\x00\x00\x92\x24"

# Restart to USB_boot (write 0x90140229 to 0x4FE1E300, the most bottom return function of the stack)
RESTART_USBBOOT_1 = b"\xFE\x00\xFF\x01\x00\x00\x00\x04\x4F\xE1\xE3\x00\x59\x34"
RESTART_USBBOOT_2 = b"\xDA\x01\xFE\x29\x02\x14\x90\xE1\x29"

def check_ok(ser):
    try:
        r = ser.read()
        if r[0] == b"\xAA":
            return True
    except:
        pass
    print("Incorrect response from the router!")
    sys.exit(1)


if len(sys.argv) != 2:
    print("{} <COM PORT>".format(sys.argv[0]))
    sys.exit(1)


with serial.Serial(sys.argv[1], rtscts=True, dsrdtr=True) as ser:
    ser.write(DISABLE_SECUBOOT_1)
    check_ok(ser)
    ser.write(DISABLE_SECUBOOT_2)
    check_ok(ser)
    ser.write(RESTART_USBBOOT_1)
    check_ok(ser)
    ser.write(RESTART_USBBOOT_2)
    check_ok(ser)
    print("Everything is OK!")
    sys.exit(0)
print("Something went wrong!")